# ğŸ—ï¸ Arquitectura Detallada - Whisper.cpp Local Transcriber

## Diagrama de Flujo Completo

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     INPUT LAYER                                    â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â•‘
â•‘  â”‚  usuario.ogg â”‚  â”‚ usuario.mp3  â”‚  â”‚ usuario.wav  â”‚  ...        â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â•‘
â•‘         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â•‘
â•‘                           â–¼                                        â•‘
â•‘         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â•‘
â•‘         â”‚  PRE-PROCESSING (ValidaciÃ³n)        â”‚                  â•‘
â•‘         â”‚  â€¢ Verificar codec                  â”‚                  â•‘
â•‘         â”‚  â€¢ Validar duraciÃ³n                 â”‚                  â•‘
â•‘         â”‚  â€¢ Detectar corrupciÃ³n              â”‚                  â•‘
â•‘         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â•‘
â•‘                        â–¼                                           â•‘
â•‘         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â•‘
â•‘         â”‚  FFMPEG CONVERSION                  â”‚                  â•‘
â•‘         â”‚  Entrada â†’ WAV 16kHz mono           â”‚                  â•‘
â•‘         â”‚  â€¢ Resampling                       â”‚                  â•‘
â•‘         â”‚  â€¢ Channel mixing                   â”‚                  â•‘
â•‘         â”‚  â€¢ Codec negotiation                â”‚                  â•‘
â•‘         â”‚  Salida: /tmp/_whisper_in.wav       â”‚                  â•‘
â•‘         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         â”‚
                         â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  INFERENCE ENGINE LAYER                            â•‘
â•‘                   (whisper-cli)                                    â•‘
â•‘                                                                    â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  1. LOAD MODEL                                              â”‚  â•‘
â•‘  â”‚     â”œâ”€ ggml-small.bin (466 MB)                             â”‚  â•‘
â•‘  â”‚     â”œâ”€ Quantized FP16 (mÃ¡s rÃ¡pido, < memoria)             â”‚  â•‘
â•‘  â”‚     â””â”€ Loaded in: ~281ms (cache despuÃ©s)                  â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                             â–¼                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  2. AUDIO FEATURE EXTRACTION                                â”‚  â•‘
â•‘  â”‚     â”œâ”€ Mel-Spectrogram generation (80 bins)               â”‚  â•‘
â•‘  â”‚     â”œâ”€ Log scaling                                        â”‚  â•‘
â•‘  â”‚     â””â”€ Normalization                                      â”‚  â•‘
â•‘  â”‚     Time: ~4ms (3 segundos audio)                         â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                             â–¼                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  3. ENCODER STACK (12 capas)                                â”‚  â•‘
â•‘  â”‚     â”œâ”€ Input: Mel-spectrogram (80Ã—1500)                   â”‚  â•‘
â•‘  â”‚     â”œâ”€ Self-Attention (12 heads, 768 dim)                â”‚  â•‘
â•‘  â”‚     â”œâ”€ Feed-Forward Networks (3072 dim)                  â”‚  â•‘
â•‘  â”‚     â””â”€ Output: Encoded representation (1500Ã—768)         â”‚  â•‘
â•‘  â”‚     Time: ~4305ms (Bulk of computation)                  â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                             â–¼                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  4. DECODER + BEAM SEARCH                                   â”‚  â•‘
â•‘  â”‚     â”œâ”€ Auto-regressive generation                         â”‚  â•‘
â•‘  â”‚     â”œâ”€ Cross-Attention con encoder output                â”‚  â•‘
â•‘  â”‚     â”œâ”€ Beam size = 5 (top 5 hypotheses)                 â”‚  â•‘
â•‘  â”‚     â”œâ”€ Temperature = 0.0 (deterministic)                â”‚  â•‘
â•‘  â”‚     â””â”€ Max tokens = 448                                  â”‚  â•‘
â•‘  â”‚     Time: ~15ms + ~180ms batching                        â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                             â–¼                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  5. POST-PROCESSING                                         â”‚  â•‘
â•‘  â”‚     â”œâ”€ Token â†’ Text decoding                             â”‚  â•‘
â•‘  â”‚     â”œâ”€ Confidence scoring                                â”‚  â•‘
â•‘  â”‚     â”œâ”€ Timestamp alignment                               â”‚  â•‘
â•‘  â”‚     â””â”€ Language detection (si es auto)                   â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                             â”‚                                     â•‘
â•‘                      TOTAL: ~4.9 segundos                        â•‘
â•‘                      (para 3 segundos de audio)                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         â”‚
                         â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    OUTPUT LAYER                                    â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â•‘
â•‘  â”‚ output.txt   â”‚  â”‚ output.vtt   â”‚  â”‚ output.json  â”‚  ...        â•‘
â•‘  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚             â•‘
â•‘  â”‚[Texto plano] â”‚  â”‚[SubtÃ­tulos]  â”‚  â”‚[Metadata]    â”‚             â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Modelo: Arquitectura Transformer

```
                      INPUT AUDIO
                           â”‚
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  MEL-SPECTROGRAM       â”‚
              â”‚  Shape: (80, 1500)     â”‚
              â”‚  80 frequency bins     â”‚
              â”‚  1500 time frames      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   POSITIONAL ENC    â”‚
                â”‚   (learnable)       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â”‚                             â”‚
      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
      â”‚  ENCODER  â”‚              â”‚  DECODER  â”‚
      â”‚ (12 capas)â”‚              â”‚ (12 capas)â”‚
      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜
            â”‚                          â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
            â”‚  â”‚  cada capa:      â”‚   â”‚
            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
            â”‚  â”‚  â”‚ Self-Attn  â”‚  â”‚   â”‚
            â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚   â”‚
            â”‚  â”‚  â”‚ Feed-Fwd   â”‚  â”‚   â”‚
            â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚   â”‚
            â”‚  â”‚  â”‚ Norm+Skip  â”‚  â”‚   â”‚
            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
            â”‚                          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        [CROSS-ATTENTION: Context + Query]
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ TOKEN GENERATION â”‚
              â”‚ (auto-regressive)â”‚
              â”‚                  â”‚
              â”‚ loop:            â”‚
              â”‚  sample token    â”‚
              â”‚  â†“               â”‚
              â”‚  add to seq      â”‚
              â”‚  â†“               â”‚
              â”‚ stop? â†’ EOF      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                  OUTPUT TEXT
```

---

## Data Flow: Monitor AutomÃ¡tico

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User: ./monitor_transcribir.sh ~/Descargas/Audio  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ inotifywait listener  â”‚
         â”‚ Watching for:         â”‚
         â”‚  .ogg, .mp3, .wav,    â”‚
         â”‚  .m4a files           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              (waiting for events...)
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ User drops audio file      â”‚
        â”‚ ~/Descargas/Audio/msg.ogg  â”‚
        â”‚ EVENT: moved_to            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Detect new file â”‚
              â”‚ Parse filename  â”‚
              â”‚ Extract basenameâ”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Call:                â”‚
              â”‚ ./transcribir.sh \   â”‚
              â”‚  msg.ogg \           â”‚
              â”‚  small \             â”‚
              â”‚  msg                 â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ TRANSCRIPTION PROCESS  â”‚
         â”‚ (async, background)     â”‚
         â”‚                         â”‚
         â”‚ 1. Convert audio        â”‚
         â”‚ 2. Run whisper-cli      â”‚
         â”‚ 3. Generate .txt        â”‚
         â”‚                         â”‚
         â”‚ Duration: ~5-10s        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Output files:           â”‚
         â”‚ msg.txt âœ…              â”‚
         â”‚ msg_whisper.log         â”‚
         â”‚ /tmp/_whisper_in.wav    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Monitor detects â”‚
              â”‚ completion      â”‚
              â”‚ Ready for next  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                (loop again)
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ User drops otro_msg.ogg  â”‚
         â”‚ Process repeats...       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Threading & Parallelization

```
WHISPER.CPP THREADING MODEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€ Main Thread â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”œâ”€ Load model from disk                               â”‚
â”‚ â”œâ”€ Parse CLI arguments                                â”‚
â”‚ â””â”€ Orchestrate inference                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”      â”Œâ”€â”€â”€â–¼â”€â”€â”€â”      â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
    â”‚Thread1â”‚      â”‚Thread2â”‚      â”‚Thread3â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚Encoderâ”‚      â”‚Encoderâ”‚      â”‚Encoderâ”‚
    â”‚Part A â”‚      â”‚Part B â”‚      â”‚Part C â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”˜
        â”‚              â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  OpenMP Barrier   â”‚ â† Sync point
             â”‚  (all threads)    â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                    â”Œâ”€â”€â–¼â”€â”€â”
                    â”‚DecodificaciÃ³nâ”‚
                    â”‚(Threads en loop)
                    â””â”€â”€â”€â”€â”€â”€â”˜


CONFIGURACIÃ“N RECOMENDADA:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

System CPU: 16 cores
Threads (-t): 4-8 (balance latencia vs throughput)
OpenMP: Enabled (default)
Load balance: ~25% per thread

Con GPU (CUDA):
â”œâ”€ Kernel execution: GPU
â”œâ”€ Data transfer: PCIe 3.0 (~16 GB/s)
â”œâ”€ Speedup: 3-5x vs CPU
â””â”€ Best for: large batch processing
```

---

## Memory Layout

```
HEAP ALLOCATION (ggml-small.bin)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Model Weights:           466 MB â”€â”
â”œâ”€ Encoder params        â‰ˆ 233 MB
â””â”€ Decoder params        â‰ˆ 233 MB

KV Cache:                75 MB â”€â”€â”
â”œâ”€ Self-attention KV     â‰ˆ 18.87 MB
â”œâ”€ Cross-attention KV    â‰ˆ 56.62 MB
â””â”€ Padding               â‰ˆ 4.72 MB

Compute Buffers:         160 MB â”€â”
â”œâ”€ Convolution buffer    â‰ˆ 22.42 MB
â”œâ”€ Encoder buffer        â‰ˆ 33.85 MB
â”œâ”€ Cross buffer          â‰ˆ 6.20 MB
â””â”€ Decoder buffer        â‰ˆ 97.28 MB

Temporary Allocations:   ~50 MB
â”œâ”€ Input embeddings
â”œâ”€ Intermediate features
â””â”€ Output logits

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TOTAL:                   ~800 MB  (peak usage)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

MEMORY TIMELINE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

t=0ms:      Model load â†’ +466 MB
t=281ms:    KV init â†’ +75 MB
t=285ms:    Compute buffers â†’ +160 MB
            â”Œâ”€ Peak: ~700 MB
t=4590ms:   Cleanup â†’ -160 MB (compute buffers freed)
t=4600ms:   Final: ~540 MB (model + KV only)
```

---

## Latency Breakdown (Timeline)

```
TRANSCRIPCIÃ“N DE AUDIO 3 SEGUNDOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Timeline (ms):  Activity:                  Cumulative:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0-10            â”‚ ffmpeg conversion        â”‚ 10 ms
                â”‚ â€¢ OGG decode             â”‚
                â”‚ â€¢ Resample to 16kHz      â”‚
                â”‚ â€¢ Mix to mono            â”‚
                â”‚                          â”‚
10-291          â”‚ Model load               â”‚ 281 ms
                â”‚ â€¢ Disk I/O               â”‚
                â”‚ â€¢ Memory mapping         â”‚
                â”‚ â€¢ Tensor initialization  â”‚
                â”‚                          â”‚
291-295         â”‚ Mel-spectrogram          â”‚ 4 ms
                â”‚ â€¢ Audio feature extract  â”‚
                â”‚                          â”‚
295-4600        â”‚ INFERENCE (main work)    â”‚ 4305 ms
                â”‚ â”Œâ”€ Encoder runs:         â”‚
                â”‚ â”‚  â€¢ Self-attention      â”‚
                â”‚ â”‚  â€¢ Feed-forward        â”‚
                â”‚ â”‚  â€¢ LayerÃ—12            â”‚
                â”‚ â”‚                        â”‚
                â”‚ â”œâ”€ Decoder runs:         â”‚
                â”‚ â”‚  â€¢ Cross-attention     â”‚
                â”‚ â”‚  â€¢ Beam search (N=5)   â”‚
                â”‚ â”‚  â€¢ Token generation    â”‚
                â”‚ â”‚                        â”‚
                â”‚ â””â”€ Total: ~4300 ms       â”‚
                â”‚                          â”‚
4600-4614       â”‚ Post-processing          â”‚ 14 ms
                â”‚ â€¢ Token decode           â”‚
                â”‚ â€¢ Timestamp alignment    â”‚
                â”‚ â€¢ Output formatting      â”‚
                â”‚                          â”‚
4614-4924       â”‚ I/O (write output)       â”‚ 310 ms
                â”‚ â€¢ .txt write             â”‚
                â”‚ â€¢ .vtt write (optional)  â”‚
                â”‚ â€¢ .json write (optional) â”‚
                â”‚                          â”‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TOTAL LATENCY: ~4.9 segundos
REAL-TIME FACTOR: 0.27x (4.9s latency for 3s audio)
THROUGHPUT: 3s audio â†’ 4.9s elapsed

OPTIMIZATIONS APPLIED:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Model quantization (FP32 â†’ FP16)
âœ“ OpenMP parallelization (4 threads)
âœ“ SIMD instructions (AVX2, FMA)
âœ“ KV cache optimization
âœ“ Beam search pruning
```

---

## Integration Scenarios

### Scenario 1: Standalone CLI

```
User
  â†“
./transcribir.sh
  â”œâ”€ Parse arguments
  â”œâ”€ Call ffmpeg
  â””â”€ Call whisper-cli
       â”œâ”€ Load model
       â”œâ”€ Inference
       â””â”€ Write output
            â†“
        Output files (.txt, .vtt, .json)
```

### Scenario 2: Daemon Mode (Monitor)

```
â”Œâ”€ Systemd Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚
â”‚ ./monitor_transcribir.sh /path    â”‚
â”‚  â”œâ”€ inotifywait loop              â”‚
â”‚  â”œâ”€ Spawn transcribir.sh (fork)   â”‚
â”‚  â”œâ”€ Wait for completion (background)
â”‚  â””â”€ Continue listening            â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   Multiple parallel transcriptions
   (limited by system resources)
```

### Scenario 3: API Server

```
â”Œâ”€ whisper-server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (OpenAI-compatible API)             â”‚
â”‚                                     â”‚
â”‚ POST /v1/audio/transcriptions      â”‚
â”‚   â”œâ”€ Upload audio file             â”‚
â”‚   â”œâ”€ Queue for processing          â”‚
â”‚   â”œâ”€ Run transcription              â”‚
â”‚   â””â”€ Return JSON response           â”‚
â”‚                                     â”‚
â”‚ GET /v1/audio/transcriptions/{id}  â”‚
â”‚   â”œâ”€ Check status                  â”‚
â”‚   â””â”€ Return result (if ready)      â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling Flow

```
â”Œâ”€ Input Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚ File exists?          â”€â”€YESâ”€â”€â”          â”‚
â”‚                        NO    â”‚ Exit(1)  â”‚
â”‚                              â”‚          â”‚
â”‚ File readable?        â”€â”€YESâ”€â”€â”¼â”€â”€â”       â”‚
â”‚                        NO    â”‚  â”‚ Exit(1)
â”‚                              â”‚  â”‚       â”‚
â”‚ File size > 0?        â”€â”€YESâ”€â”€â”¼â”€â”€â”¼â”€â”€â”    â”‚
â”‚                        NO    â”‚  â”‚  â”‚Exit(1)
â”‚                              â”‚  â”‚  â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”˜
                               â”‚  â”‚  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â–¼â”€â”€â–¼â”€â”€â”€â”
                    â”‚ Audio Format Check  â”‚
                    â”‚                    â”‚
                    â”‚ ffprobe validation â”‚
                    â”‚ â”œâ”€ Codec OK?      â”‚
                    â”‚ â”œâ”€ Duration OK?   â”‚
                    â”‚ â””â”€ Sample rate OK?â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚      â”‚
                         YES      NOâ†’ Attempt re-encode
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ffmpeg convert  â”‚
                    â”‚                â”‚
                    â”‚ Errors:        â”‚
                    â”‚ â”œâ”€ codec err   â”‚
                    â”‚ â”œâ”€ timeout     â”‚
                    â”‚ â””â”€ disk full   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                           â”‚      â”‚
                         OK       Failâ†’ Exit(2)
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ whisper-cli    â”‚
                    â”‚                â”‚
                    â”‚ Errors:        â”‚
                    â”‚ â”œâ”€ model miss  â”‚
                    â”‚ â”œâ”€ mem fail    â”‚
                    â”‚ â””â”€ gpu fail    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                           â”‚      â”‚
                         OK       Failâ†’ Fallback/Exit
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Output write   â”‚
                    â”‚                â”‚
                    â”‚ Errors:        â”‚
                    â”‚ â”œâ”€ permission  â”‚
                    â”‚ â”œâ”€ disk full   â”‚
                    â”‚ â””â”€ read-only   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                           â”‚      â”‚
                         OK       Failâ†’ Exit(3)
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ âœ… SUCCESS     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Performance Comparison

```
COMPARACIÃ“N DE MODELOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                    tiny        base      small    medium   large
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TamaÃ±o            39 MB       139 MB    465 MB    1.5 GB   3 GB
Tiempo (1min)     ~2s         ~4s       ~8s       ~15s     ~25s
PrecisiÃ³n         â­â­        â­â­â­    â­â­â­â­  â­â­â­â­â­ â­â­â­â­â­â­
RAM               200 MB      400 MB    800 MB    2 GB     4 GB
EspaÃ±ol           BÃ¡sico      Bueno     Excelente Ã“ptimo   Perfecto
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

RECOMENDACIONES POR CASO DE USO:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Prototipo rÃ¡pido      â†’ tiny
Testing general       â†’ base
ProducciÃ³n estÃ¡ndar   â†’ small â­
Audio profesional     â†’ medium
MÃ¡xima precisiÃ³n      â†’ large (si hay recursos)

CROSS-MODEL ACCURACY (WER - Word Error Rate):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Audio limpio:      tiny=15% | base=8% | small=5% | medium=3% | large=2%
Ruido moderado:    tiny=25% | base=15% | small=10% | medium=6% | large=4%
Ruido alto:        tiny=40% | base=30% | small=20% | medium=12% | large=8%
```

---

## Sistema de CachÃ©s

```
CACHE HIERARCHY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Level 1: KV Cache (In-Memory)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stores attention keys/values    â”‚
â”‚ from previous inference steps   â”‚
â”‚                                 â”‚
â”‚ Size: 75 MB (per inference)    â”‚
â”‚ Access Time: <1ms              â”‚
â”‚ Hit Rate: ~100% (reused)       â”‚
â”‚                                 â”‚
â”‚ Benefit: Prevents recomputationâ”‚
â”‚ Speedup: ~30% on decoder       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Level 2: Model Cache (Disk â†’ Memory)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ggml-small.bin (466 MB)         â”‚
â”‚ Memory-mapped on first load     â”‚
â”‚                                 â”‚
â”‚ After first run:                â”‚
â”‚ â”œâ”€ Model stays in RAM           â”‚
â”‚ â”œâ”€ Subsequent runs: +281ms load â”‚
â”‚ â””â”€ Can persist to SSD cache     â”‚
â”‚                                 â”‚
â”‚ Benefit: Zero reload on reuse   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Level 3: System Cache (Filesystem)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OS page cache manages ggml-bin  â”‚
â”‚ Automatic with mmap             â”‚
â”‚                                 â”‚
â”‚ Benefit:                        â”‚
â”‚ â”œâ”€ Automatic eviction           â”‚
â”‚ â”œâ”€ Pressure relief              â”‚
â”‚ â””â”€ Swap-free operation          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CACHE INVALIDATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Model changes â†’ Clear Level 2
- Audio format changes â†’ Clear Level 1
- Language setting changes â†’ Keep (model-agnostic)
```

---

**Ãšltima actualizaciÃ³n:** 17 de Diciembre, 2025  
**VersiÃ³n:** 1.0 - Arquitectura Completa
